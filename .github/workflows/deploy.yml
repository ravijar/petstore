name: Deploy to Railway

on:
  push:
    branches:
      - master  # Trigger deployment on push to the master branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Set up Docker Buildx for multi-platform support
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      # Step 3: Install Railway CLI
      - name: Install Railway CLI
        run: |
          curl -sSL https://railway.app/install.sh | bash
          # Add Railway CLI to the PATH for subsequent steps
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      # Step 4: Set up Google Cloud service account credentials
      - name: Set up Google Cloud credentials
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > service-account-file.json
          # The file is already in the correct location, so no need to move it
          ls -l service-account-file.json  # Optional: List to confirm the file is created

      # Step 5: Build the Docker image
      - name: Build Docker image
        run: |
          docker build --build-arg GOOGLE_APPLICATION_CREDENTIALS=service-account-file.json -t ravijar/petstore .

      # Step 6: Set the Railway API Key and login
      - name: Set Railway API Key and Login
        run: |
          export RAILWAY_API_KEY=${{ secrets.RAILWAY_API_KEY }}
          railway login  # This will use the RAILWAY_API_KEY environment variable

      # Step 7: Deploy to Railway
      - name: Deploy to Railway
        run: |
          railway up  # This command deploys your app to Railway
